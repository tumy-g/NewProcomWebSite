import{r as t,h as i,c as e,H as s,g as o}from"./p-33b9aa6b.js";import{Logger as r,browserOrNode as a,I18n as n}from"@aws-amplify/core";import"@aws-amplify/auth";import{T as h}from"./p-956a9917.js";import{c as l}from"./p-900152ca.js";import{Interactions as d}from"@aws-amplify/interactions";const c=(t,i,e)=>{for(let s=0;s<e.length;s++)t.setUint8(i+s,e.charCodeAt(s))},m=(t,i,e,s)=>{const o=((t,i)=>{const e=2*t.length,s=8+e,o=new ArrayBuffer(36+s),r=new DataView(o);return c(r,0,"RIFF"),r.setUint32(4,24+s,!0),c(r,8,"WAVE"),c(r,12,"fmt "),r.setUint32(16,16,!0),r.setUint16(20,1,!0),r.setUint16(22,1,!0),r.setUint32(24,i,!0),r.setUint32(28,2*i,!0),r.setUint16(32,2,!0),r.setUint16(34,16,!0),c(r,36,"data"),r.setUint32(40,e,!0),((t,i,e)=>{let s=44;for(let o=0;o<e.length;o++,s+=2){const i=Math.max(-1,Math.min(1,e[o]));t.setInt16(s,i<0?32768*i:32767*i,!0)}})(r,0,t),r})(((t,i,e)=>{if(e===i)return t;const s=i/e,o=Math.round(t.length/s),r=new Float32Array(o);let a=0,n=0;for(;a<r.length;){const i=Math.round((a+1)*s);let e=0,o=0;for(let s=n;s<i&&s<t.length;s++)e+=t[s],o++;r[a]=e/o,a++,n=i}return r})(((t,i)=>{const e=new Float32Array(i);let s=0;for(let o=0;o<t.length;o++)e.set(t[o],s),s+=t[o].length;return e})(t,i),e,s),s);return new Blob([o],{type:"application/octet-stream"})},f=new r("AudioRecorder");class u{constructor(t){this.streamBuffer=[],this.streamBufferLength=0,this.recording=!1,this.options=t}async init(){if(!a().isBrowser)return this.audioSupported=!1,Promise.reject("Audio is not supported");window.AudioContext=window.AudioContext||window.webkitAudioContext,this.audioContext=new AudioContext,await navigator.mediaDevices.getUserMedia({audio:!0}).then(t=>{this.audioSupported=!0,this.setupAudioNodes(t)}).catch(()=>(this.audioSupported=!1,Promise.reject("Audio is not supported")))}async setupAudioNodes(t){try{await this.audioContext.resume()}catch(o){f.error(o)}const i=this.audioContext.createMediaStreamSource(t),e=this.audioContext.createScriptProcessor(4096,1,1);e.onaudioprocess=t=>{if(!this.recording)return;const i=t.inputBuffer.getChannelData(0);this.streamBuffer.push(new Float32Array(i)),this.streamBufferLength+=i.length,this.analyse()};const s=this.audioContext.createAnalyser();s.minDecibels=-90,s.maxDecibels=-10,s.smoothingTimeConstant=.85,i.connect(s),s.connect(e),e.connect(i.context.destination),this.analyserNode=s}async startRecording(t,i){if(this.recording||!this.audioSupported)return;this.onSilence=t||function(){},this.visualizer=i||function(){};const e=this.audioContext;try{await e.resume()}catch(s){f.error(s)}this.start=Date.now(),this.recording=!0}stopRecording(){this.audioSupported&&(this.recording=!1)}clear(){this.stopRecording(),this.streamBufferLength=0,this.streamBuffer=[]}play(t){if(!t||!this.audioSupported)return;const i=new Blob([t]);return new Promise((t,e)=>{const s=new FileReader;s.onload=()=>{this.playbackSource&&this.playbackSource.disconnect(),this.playbackSource=this.audioContext.createBufferSource(),this.audioContext.decodeAudioData(s.result,i=>{this.playbackSource.buffer=i,this.playbackSource.connect(this.audioContext.destination),this.playbackSource.onended=()=>t(),this.playbackSource.start(0)},t=>e(t))},s.onerror=()=>e(),s.readAsArrayBuffer(i)})}stop(){this.playbackSource&&this.playbackSource.stop()}analyse(){if(!this.audioSupported)return;const t=this.analyserNode;t.fftSize=2048;const i=t.fftSize,e=new Uint8Array(i),s=this.options.amplitude,o=this.options.time;t.getByteTimeDomainData(e),this.visualizer(e,i);for(let r=0;r<i;r++){const t=e[r]/128-1;(t>s||t<-1*s)&&(this.start=Date.now())}Date.now()-this.start>o&&this.onSilence()}async exportWAV(t=16e3){if(!this.audioSupported)return;const i=m(this.streamBuffer,this.streamBufferLength,this.audioContext.sampleRate,t);return this.clear(),i}}var b,p,g;!function(t){t[t.Initial=0]="Initial",t[t.Listening=1]="Listening",t[t.SendingText=2]="SendingText",t[t.SendingVoice=3]="SendingVoice",t[t.Error=4]="Error"}(b||(b={})),function(t){t.Bot="bot",t.User="user"}(p||(p={})),function(t){t[t.Recoverable=0]="Recoverable",t[t.Unrecoverable=1]="Unrecoverable"}(g||(g={}));const y=class{constructor(s){t(this,s),this.clearOnComplete=!1,this.conversationModeOn=!1,this.botTitle=h.CHATBOT_TITLE,this.voiceEnabled=!1,this.textEnabled=!0,this.silenceTime=1500,this.silenceThreshold=.2,this.messages=[],this.text="",this.chatState=b.Initial,this.messageJSX=t=>{const e=t.map(t=>i("div",{class:"bubble "+t.from},t.content));if(this.chatState===b.SendingText||this.chatState===b.SendingVoice){const t=this.chatState===b.SendingText?p.Bot:p.User;e.push(i("div",{class:"bubble "+t},i("div",{class:"dot-flashing "+t},i("span",{class:"dot left"}),i("span",{class:"dot middle"}),i("span",{class:"dot right"}))))}return e},this.chatCompleted=e(this,"chatCompleted",7)}submitHandler(t){this.sendTextMessage()}componentWillLoad(){if(console.warn("Version `1.x` of Amplify UI has been deprecated and will be removed in a future major version of `aws-amplify`. Please visit https://ui.docs.amplify.aws/ for the current version of Amplify UI."),!d||"function"!=typeof d.onComplete)throw new Error(l);this.validateProps()}componentDidRender(){const t=this.element.shadowRoot.querySelector(".body");t.scrollTop=t.scrollHeight}validateProps(){if(!this.voiceEnabled&&!this.textEnabled)return void this.setError(h.CHAT_DISABLED_ERROR,g.Unrecoverable);if(!this.botName)return void this.setError(h.NO_BOT_NAME_ERROR,g.Unrecoverable);this.welcomeMessage&&this.appendToChat(this.welcomeMessage,p.Bot),this.voiceEnabled&&(this.audioRecorder=new u({time:this.silenceTime,amplitude:this.silenceThreshold}),this.audioRecorder.init().catch(t=>{this.setError(t,g.Recoverable)}));const t=(t,i)=>{this.chatCompleted.emit({data:i,err:t}),this.clearOnComplete?this.reset():this.chatState=b.Initial};try{d.onComplete(this.botName,t)}catch(i){this.setError(i,g.Unrecoverable)}}handleSubmit(t){t.preventDefault(),this.sendTextMessage()}handleMicButton(){this.chatState===b.Initial&&(this.audioRecorder.stop(),this.chatState=b.Listening,this.audioRecorder.startRecording(()=>this.handleSilence(),(t,i)=>this.visualizer(t,i)))}handleSilence(){this.chatState=b.SendingVoice,this.audioRecorder.stopRecording(),this.audioRecorder.exportWAV().then(t=>{this.sendVoiceMessage(t)})}handleTextChange(t){this.text=t.target.value}handleCancelButton(){this.audioRecorder.clear(),this.chatState=b.Initial}handleToastClose(t){this.error=void 0,t===g.Recoverable&&(this.chatState=b.Initial)}visualizer(t,i){((t,i,e)=>{if(!e)return;if(!a().isBrowser)throw new Error("Visualization is not supported on non-browsers.");const{width:s,height:o}=e.getBoundingClientRect();e.width=s,e.height=o;const r=e.getContext("2d");r.fillStyle="white",r.clearRect(0,0,s,o),requestAnimationFrame(()=>{r.fillRect(0,0,s,o),r.lineWidth=1;const a=getComputedStyle(document.documentElement).getPropertyValue("--amplify-primary-color");r.strokeStyle=a&&""!==a?a:"#ff9900",r.beginPath();const n=1*s/i;let h=0;for(let e=0;e<i||e%3==0;e++){const i=t[e]/128*o/2;0===e?r.moveTo(h,i):r.lineTo(h,i),h+=n}r.lineTo(e.width,e.height/2),r.stroke()})})(t,i,this.element.shadowRoot.querySelector("canvas"))}async sendTextMessage(){if(0===this.text.length||this.chatState!==b.Initial)return;const t=this.text;let i;this.text="",this.appendToChat(t,p.User),this.chatState=b.SendingText;try{i=await d.send(this.botName,t)}catch(e){return void this.setError(e,g.Recoverable)}i.message&&this.appendToChat(i.message,p.Bot),this.chatState=b.Initial}async sendVoiceMessage(t){const i={content:t,options:{messageType:"voice"}};let e;try{e=await d.send(this.botName,i)}catch(o){return void this.setError(o,g.Recoverable)}this.chatState=b.Initial;const s=e.dialogState;e.inputTranscript&&this.appendToChat(e.inputTranscript,p.User),this.appendToChat(e.message,p.Bot),await this.audioRecorder.play(e.audioStream).then(()=>{this.conversationModeOn&&"Fulfilled"!==s&&"Failed"!==s&&this.chatState===b.Initial&&this.handleMicButton()}).catch(t=>this.setError(t,g.Recoverable))}appendToChat(t,i){this.messages=[...this.messages,{content:t,from:i}]}setError(t,i){const e="string"==typeof t?t:t.message;this.chatState=b.Error,this.error={message:e,errorType:i}}reset(){this.chatState=b.Initial,this.text="",this.error=void 0,this.messages=[],this.welcomeMessage&&this.appendToChat(this.welcomeMessage,p.Bot),this.audioRecorder&&this.audioRecorder.clear()}listeningFooterJSX(){return[i("canvas",{height:"50"}),i("amplify-button",{"data-test":"chatbot-cancel-button",handleButtonClick:()=>this.handleCancelButton(),class:"icon-button",variant:"icon",icon:"ban"})]}footerJSX(){return this.chatState===b.Listening?this.listeningFooterJSX():[i("amplify-input",{placeholder:n.get(this.textEnabled?h.TEXT_INPUT_PLACEHOLDER:h.VOICE_INPUT_PLACEHOLDER),description:"text",handleInputChange:t=>this.handleTextChange(t),value:this.text,disabled:this.chatState===b.Error||!this.textEnabled}),this.voiceEnabled&&i("amplify-button",{"data-test":"chatbot-mic-button",handleButtonClick:()=>this.handleMicButton(),class:"icon-button",variant:"icon",icon:"microphone",disabled:this.chatState===b.Error||this.chatState!==b.Initial}),this.textEnabled&&i("amplify-button",{"data-test":"chatbot-send-button",class:"icon-button",variant:"icon",icon:"send",handleButtonClick:()=>this.sendTextMessage(),disabled:this.chatState===b.Error||this.chatState!==b.Initial})]}errorToast(){if(!this.error)return;const{message:t,errorType:e}=this.error;return i("amplify-toast",{message:n.get(t),handleClose:()=>this.handleToastClose(e)})}render(){return i(s,null,i("div",{class:"amplify-chatbot"},i("slot",{name:"header"},i("div",{class:"header","data-test":"chatbot-header"},n.get(this.botTitle))),i("div",{class:"body","data-test":"chatbot-body"},this.messageJSX(this.messages)),i("form",{onSubmit:t=>this.handleSubmit(t)},i("div",{class:"footer","data-test":"chatbot-footer"},this.footerJSX())),this.errorToast()))}get element(){return o(this)}};y.style=".bot .dot{background-color:var(--bot-dot-color)}.user .dot{background-color:var(--user-dot-color)}.dot-flashing{width:2.625rem}.dot-flashing .dot{display:inline-block;width:0.625rem;height:0.625rem;border-radius:10rem;opacity:0.65}.dot-flashing .left{-webkit-animation:dot-flashing 1s infinite alternate;animation:dot-flashing 1s infinite alternate;-webkit-animation-delay:0s;animation-delay:0s}.dot-flashing .middle{margin-left:0.375rem;margin-right:0.375rem;-webkit-animation:dot-flashing 1s infinite linear alternate;animation:dot-flashing 1s infinite linear alternate;-webkit-animation-delay:0.5s;animation-delay:0.5s}.dot-flashing .right{-webkit-animation:dot-flashing 1s infinite alternate;animation:dot-flashing 1s infinite alternate;-webkit-animation-delay:1s;animation-delay:1s}@-webkit-keyframes dot-flashing{0%{opacity:0.65}50%,100%{opacity:0.1}}@keyframes dot-flashing{0%{opacity:0.65}50%,100%{opacity:0.1}}:host{--width:28.75rem;--height:37.5rem;--header-color:var(--amplify-secondary-color);--header-size:var(--amplify-text-lg);--bot-background-color:rgb(230, 230, 230);--bot-text-color:black;--bot-dot-color:var(--bot-text-color);--user-background-color:var(--amplify-blue);--user-text-color:var(--amplify-white);--user-dot-color:var(--user-text-color)}.amplify-chatbot{display:-ms-inline-flexbox;display:inline-flex;-ms-flex-direction:column;flex-direction:column;background-color:var(--background-color);border-radius:0.375rem;-webkit-box-shadow:0.0625rem 0rem 0.25rem 0 rgba(0, 0, 0, 0.15);box-shadow:0.0625rem 0rem 0.25rem 0 rgba(0, 0, 0, 0.15);-webkit-box-sizing:border-box;box-sizing:border-box;font-family:var(--amplify-font-family);margin-bottom:1rem;width:100%;height:var(--height);max-width:var(--width)}@media (min-width: 672px){.amplify-chatbot{width:var(--width)}}.header{padding:1.25rem 0.375rem 1.25rem 0.375rem;color:var(--header-color);font-size:var(--header-size);font-weight:bold;text-align:center;word-wrap:break-word}.body{border-top:0.0625rem solid rgba(0, 0, 0, 0.05);padding:1.5rem 1rem 0 1rem;display:-ms-flexbox;display:flex;-ms-flex-positive:1;flex-grow:1;-ms-flex-direction:column;flex-direction:column;overflow:auto}.bubble{max-width:100%;padding:0.8em 1.4em;text-align:left;word-wrap:break-word;margin-bottom:0.625rem}.bot{margin-right:auto;background-color:var(--bot-background-color);color:var(--bot-text-color);border-radius:1.5rem 1.5rem 1.5rem 0}.user{margin-left:auto;background-color:var(--user-background-color);color:var(--user-text-color);border-radius:1.5rem 1.5rem 0 1.5rem}.footer{display:-ms-flexbox;display:flex;-ms-flex-align:center;align-items:center;border-top:0.062rem solid rgba(0, 0, 0, 0.05);padding-right:0.625rem;min-height:3.125rem}.footer amplify-input{--border:none;--margin:0;-ms-flex-positive:1;flex-grow:1}canvas{margin-left:0.625rem;margin-right:0.625rem;-ms-flex-positive:1;flex-grow:1;height:3.125rem}.icon-button{--icon-height:1.25rem;--icon-fill:var(--amplify-primary-color);--padding:0.625rem;--width:auto}";export{y as amplify_chatbot}